<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìä Plan de Liquidaci√≥n de Deudas - Alejandro</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#2c3e50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Deudas Alejandro">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%232c3e50'/><text y='50' x='50' fill='white' text-anchor='middle' dominant-baseline='middle' font-size='40'>üí∞</text></svg>">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%232c3e50'/><text y='50' x='50' fill='white' text-anchor='middle' dominant-baseline='middle' font-size='40'>üí∞</text></svg>">
    <link rel="manifest" href="data:application/json,{&quot;name&quot;:&quot;Plan Deudas Alejandro&quot;,&quot;short_name&quot;:&quot;Deudas&quot;,&quot;start_url&quot;:&quot;.&quot;,&quot;display&quot;:&quot;standalone&quot;,&quot;background_color&quot;:&quot;%23667eea&quot;,&quot;theme_color&quot;:&quot;%232c3e50&quot;,&quot;icons&quot;:[{&quot;src&quot;:&quot;data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect width='512' height='512' fill='%232c3e50'/><text y='256' x='256' fill='white' text-anchor='middle' dominant-baseline='middle' font-size='200'>üí∞</text></svg>&quot;,&quot;sizes&quot;:&quot;512x512&quot;,&quot;type&quot;:&quot;image/svg+xml&quot;}]}">
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0 0 10px 0;
            font-size: 2.2em;
            font-weight: 600;
        }
        
        .header p {
            margin: 0;
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            padding: 30px;
            background: #f8f9fa;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.08);
            text-align: center;
            border-left: 5px solid;
        }
        
        .stat-card.debt { border-left-color: #e74c3c; }
        .stat-card.payment { border-left-color: #27ae60; }
        .stat-card.progress { border-left-color: #3498db; }
        .stat-card.savings { border-left-color: #f39c12; }
        
        .stat-number {
            font-size: 2.2em;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .payment-input-section {
            background: #f8f9fa;
            padding: 30px;
            border-top: 3px solid #3498db;
        }
        
        .payment-form {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.08);
            max-width: 600px;
            margin: 0 auto;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .form-input, .form-select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .table-container {
            padding: 30px;
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        th {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 18px 12px;
            text-align: center;
            font-weight: 600;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        td {
            padding: 15px 12px;
            text-align: center;
            border-bottom: 1px solid #ecf0f1;
            font-size: 0.95em;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .month-header {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%) !important;
            color: white !important;
            font-weight: bold;
        }
        
        .quinzena {
            background: #ecf0f1;
            font-weight: 500;
        }
        
        .amount {
            font-weight: 600;
            font-family: 'Courier New', monospace;
        }
        
        .positive { color: #27ae60; }
        .negative { color: #e74c3c; }
        .neutral { color: #34495e; }
        .liquidated { 
            background: #d5f4e6; 
            color: #27ae60; 
            font-weight: bold;
        }
        
        .paid-row {
            background: #d5f4e6 !important;
            border-left: 5px solid #27ae60 !important;
        }
        
        .over-payment {
            background: #e8f5e8 !important;
            color: #27ae60 !important;
        }
        
        .under-payment {
            background: #ffeaea !important;
            color: #e74c3c !important;
        }
        
        .progress-bar {
            background: #ecf0f1;
            border-radius: 10px;
            height: 8px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #27ae60, #2ecc71);
            border-radius: 10px;
            transition: width 0.5s ease;
        }
        
        .debt-tracker {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .debt-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.08);
        }
        
        .debt-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .bbva { color: #1e3a8a; }
        .cmr { color: #dc2626; }
        .bcp { color: #059669; }
        
        .controls {
            padding: 30px;
            background: #f8f9fa;
            border-top: 1px solid #dee2e6;
        }
        
        .btn {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            margin: 5px;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(52, 152, 219, 0.3);
        }
        
        .btn.success {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        }
        
        .btn.success:hover {
            box-shadow: 0 8px 20px rgba(39, 174, 96, 0.3);
        }
        
        .btn.danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }
        
        .summary {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
            padding: 25px;
            margin: 20px 0;
            border-radius: 12px;
            text-align: center;
        }
        
        .chart-container {
            height: 400px;
            margin: 30px 0;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.05);
        }
        
        .alert {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            font-weight: 600;
        }
        
        .alert.success {
            background: #d5f4e6;
            color: #27ae60;
            border: 1px solid #27ae60;
        }
        
        .alert.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffc107;
        }
        
        .alert.danger {
            background: #ffeaea;
            color: #e74c3c;
            border: 1px solid #e74c3c;
        }
        
        .payment-history {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.05);
        }
        
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .firebase-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
            z-index: 1000;
        }
        
        .firebase-connected {
            background: #d5f4e6;
            color: #27ae60;
        }
        
        .firebase-error {
            background: #ffeaea;
            color: #e74c3c;
        }
        
        @media (max-width: 768px) {
            table { font-size: 0.8em; }
            th, td { padding: 10px 8px; }
            .stats-cards { grid-template-columns: 1fr; }
            .debt-tracker { grid-template-columns: 1fr; }
            .btn-group { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="firebase-status" id="firebaseStatus">üîÑ Conectando...</div>
    
    <div class="container">
        <div class="header">
            <h1>üìä Plan de Liquidaci√≥n de Deudas</h1>
            <p>Alejandro - Seguimiento en Tiempo Real</p>
        </div>
        
        <div class="stats-cards">
            <div class="stat-card debt">
                <div class="stat-number negative" id="totalDebt">S/ 5,782</div>
                <div class="stat-label">Deuda Total Inicial</div>
            </div>
            <div class="stat-card payment">
                <div class="stat-number positive" id="totalPayments">S/ 0</div>
                <div class="stat-label">Total Pagado Real</div>
            </div>
            <div class="stat-card progress">
                <div class="stat-number neutral" id="progressPercent">0%</div>
                <div class="stat-label">Progreso</div>
            </div>
            <div class="stat-card savings">
                <div class="stat-number positive" id="projectedSavings">S/ 2,706</div>
                <div class="stat-label">Ahorro vs Plan Original</div>
            </div>
        </div>
        
        <div class="payment-input-section">
            <div class="payment-form">
                <h2 style="text-align: center; margin-bottom: 25px; color: #2c3e50;">üí∞ Registrar Pago Real</h2>
                
                <div class="form-group">
                    <label class="form-label">Per√≠odo de Pago:</label>
                    <select class="form-select" id="paymentPeriod">
                        <option value="">Selecciona el per√≠odo...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Banco:</label>
                    <select class="form-select" id="paymentBank">
                        <option value="">Selecciona banco...</option>
                        <option value="bbva">BBVA</option>
                        <option value="cmr">CMR Falabella</option>
                        <option value="bcp">BCP Visa</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Monto Pagado (S/):</label>
                    <input type="number" class="form-input" id="paymentAmount" placeholder="Ej: 650" min="0" step="0.01">
                </div>
                
                <div class="btn-group">
                    <button class="btn success" onclick="registerPayment()">‚úÖ Registrar Pago</button>
                    <button class="btn" onclick="showPlanVsReal()">üìä Plan vs Realidad</button>
                    <button class="btn danger" onclick="resetAllData()">üîÑ Resetear Todo</button>
                </div>
                
                <div id="alertContainer"></div>
            </div>
        </div>
        
        <div class="payment-history" id="paymentHistory" style="display: none;">
            <h3>üìã Historial de Pagos Reales</h3>
            <div id="historyList"></div>
        </div>
        
        <div class="table-container">
            <table id="paymentTable">
                <thead>
                    <tr>
                        <th>Per√≠odo</th>
                        <th>Ingreso</th>
                        <th>Gastos B√°sicos</th>
                        <th>Plan BBVA</th>
                        <th>Real BBVA</th>
                        <th>Plan CMR</th>
                        <th>Real CMR</th>
                        <th>Plan BCP</th>
                        <th>Real BCP</th>
                        <th>Saldo CMR</th>
                        <th>Saldo BCP</th>
                        <th>Saldo BBVA</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody id="paymentBody">
                </tbody>
            </table>
        </div>
        
        <div class="debt-tracker" id="debtCards">
        </div>
        
        <div class="chart-container">
            <canvas id="debtChart"></canvas>
        </div>
        
        <div class="summary" id="summarySection">
            <h2>üéØ Resumen Din√°mico</h2>
            <div id="summaryContent"></div>
        </div>
        
        <div class="controls">
            <button class="btn" onclick="exportToCSV()">üì• Exportar a CSV</button>
            <button class="btn" onclick="showProjection()">üîÆ Ver Proyecci√≥n Actualizada</button>
            <button class="btn success" onclick="saveToFirebase()">üíæ Guardar en Firebase</button>
        </div>
    </div>

    <!-- Firebase SDK v9 modular -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCEBPo0pqfBKbEcsi1esVRVEGo2RhZvk0k",
            authDomain: "proyecto-deudas-c2c5f.firebaseapp.com",
            projectId: "proyecto-deudas-c2c5f",
            storageBucket: "proyecto-deudas-c2c5f.firebasestorage.app",
            messagingSenderId: "952862457135",
            appId: "1:952862457135:web:24e436a2add1f9e73475da"
        };

        // Initialize Firebase
        let app, db;
        let isFirebaseReady = false;

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            isFirebaseReady = true;
            updateFirebaseStatus('‚úÖ Firebase Conectado', 'firebase-connected');
            console.log('Firebase inicializado correctamente');
        } catch (error) {
            console.error('Error inicializando Firebase:', error);
            updateFirebaseStatus('‚ùå Firebase Error', 'firebase-error');
        }

        // Make Firebase functions available globally
        window.saveToFirebase = saveToFirebase;
        window.loadFromFirebase = loadFromFirebase;
        window.db = db;
        window.isFirebaseReady = isFirebaseReady;
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.deleteDoc = deleteDoc;
        window.doc = doc;

        async function saveToFirebase() {
            if (!isFirebaseReady) {
                showAlert('‚ùå Firebase no est√° disponible', 'danger');
                return;
            }

            try {
                // Guardar cada pago como un documento separado
                for (const [key, payment] of Object.entries(realPayments)) {
                    await addDoc(collection(db, "payments"), {
                        key: key,
                        period: payment.period,
                        bank: payment.bank,
                        amount: payment.amount,
                        planned: payment.planned,
                        date: payment.date,
                        timestamp: new Date()
                    });
                }
                
                showAlert('‚úÖ Datos guardados en Firebase correctamente', 'success');
            } catch (error) {
                console.error('Error guardando en Firebase:', error);
                showAlert('‚ùå Error al guardar en Firebase: ' + error.message, 'danger');
            }
        }

        async function loadFromFirebase() {
            if (!isFirebaseReady) {
                return;
            }

            try {
                const querySnapshot = await getDocs(collection(db, "payments"));
                const loadedPayments = {};
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    loadedPayments[data.key] = {
                        period: data.period,
                        bank: data.bank,
                        amount: data.amount,
                        planned: data.planned,
                        date: data.date
                    };
                });
                
                realPayments = loadedPayments;
                recalculateBalances();
                updateTable();
                updateStats();
                updateChart();
                updateDebtCards();
                showPaymentHistory();
                
                if (Object.keys(loadedPayments).length > 0) {
                    showAlert(`‚úÖ ${Object.keys(loadedPayments).length} pagos cargados desde Firebase`, 'success');
                }
            } catch (error) {
                console.error('Error cargando desde Firebase:', error);
                showAlert('‚ùå Error al cargar desde Firebase: ' + error.message, 'danger');
            }
        }

        function updateFirebaseStatus(message, className) {
            const status = document.getElementById('firebaseStatus');
            status.textContent = message;
            status.className = `firebase-status ${className}`;
        }
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <script>
        // Datos del plan original
        const originalPlan = [
            { period: "Sep Q1 (05/09)", income: 1000, expenses: 500, bbva: 373, cmr: 200, bcp: 0, type: "quinzena" },
            { period: "Sep Q2 (15-22/09)", income: 1200, expenses: 500, bbva: 0, cmr: 365, bcp: 178, type: "quinzena" },
            { period: "Oct Q1 (05/10)", income: 1000, expenses: 500, bbva: 373, cmr: 400, bcp: 0, type: "quinzena" },
            { period: "Oct Q2 (15-22/10)", income: 1200, expenses: 500, bbva: 0, cmr: 465, bcp: 178, type: "quinzena" },
            { period: "Nov Q1 (05/11)", income: 1000, expenses: 500, bbva: 373, cmr: 0, bcp: 400, type: "quinzena" },
            { period: "Nov Q2 (15-22/11)", income: 1200, expenses: 500, bbva: 0, cmr: 0, bcp: 478, type: "quinzena" },
            { period: "Dic Q1 (05/12)", income: 1000, expenses: 500, bbva: 573, cmr: 0, bcp: 0, type: "quinzena" },
            { period: "Dic Q2 (15-22/12)", income: 1200, expenses: 500, bbva: 700, cmr: 0, bcp: 0, type: "quinzena" }
        ];

        // Saldos iniciales
        const initialBalances = { bbva: 3976, cmr: 947, bcp: 903 };
        
        // Datos de pagos reales
        let realPayments = {};
        let currentBalances = { ...initialBalances };

        function formatMoney(amount) {
            return `S/ ${amount.toLocaleString('es-PE')}`;
        }

        function populatePeriodDropdown() {
            const select = document.getElementById('paymentPeriod');
            originalPlan.forEach((period, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = period.period;
                select.appendChild(option);
            });
        }

        async function registerPayment() {
            const periodIndex = document.getElementById('paymentPeriod').value;
            const bank = document.getElementById('paymentBank').value;
            const amount = parseFloat(document.getElementById('paymentAmount').value);

            if (!periodIndex || !bank || !amount) {
                showAlert('‚ö† Por favor completa todos los campos', 'danger');
                return;
            }

            const period = originalPlan[periodIndex];
            const key = `${periodIndex}-${bank}`;
            
            // Guardar pago real
            const paymentData = {
                period: period.period,
                bank: bank,
                amount: amount,
                planned: period[bank] || 0,
                date: new Date().toLocaleString('es-PE')
            };

            realPayments[key] = paymentData;

            // Guardar en Firebase si est√° disponible
            if (window.isFirebaseReady) {
                try {
                    await window.addDoc(window.collection(window.db, "payments"), {
                        key: key,
                        ...paymentData,
                        timestamp: new Date()
                    });
                    console.log('Pago guardado en Firebase');
                } catch (error) {
                    console.error('Error guardando en Firebase:', error);
                    showAlert('‚ö† Guardado localmente (Firebase no disponible)', 'warning');
                }
            }

            // Recalcular todo
            recalculateBalances();
            updateTable();
            updateStats();
            updateChart();
            updateDebtCards();
            showPaymentHistory();

            // Mostrar alerta seg√∫n el pago
            const planned = period[bank] || 0;
            const difference = amount - planned;
            
            if (difference > 0) {
                showAlert(`üéâ ¬°Excelente! Pagaste S/ ${difference} extra a ${bank.toUpperCase()}`, 'success');
            } else if (difference < 0) {
                showAlert(`‚ö†Ô∏è Pagaste S/ ${Math.abs(difference)} menos de lo planeado a ${bank.toUpperCase()}`, 'warning');
            } else {
                showAlert(`‚úÖ Pago exacto seg√∫n plan a ${bank.toUpperCase()}`, 'success');
            }

            // Limpiar formulario
            document.getElementById('paymentPeriod').value = '';
            document.getElementById('paymentBank').value = '';
            document.getElementById('paymentAmount').value = '';
        }

        function recalculateBalances() {
            currentBalances = { ...initialBalances };
            
            // Aplicar pagos reales en orden cronol√≥gico
            originalPlan.forEach((period, index) => {
                ['bbva', 'cmr', 'bcp'].forEach(bank => {
                    const key = `${index}-${bank}`;
                    if (realPayments[key]) {
                        currentBalances[bank] -= realPayments[key].amount;
                        currentBalances[bank] = Math.max(0, currentBalances[bank]); // No negativo
                    }
                });
            });
        }

        function updateTable() {
            const tbody = document.getElementById('paymentBody');
            tbody.innerHTML = '';
            
            originalPlan.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.classList.add('quinzena');
                
                // Verificar si hay pagos reales para este per√≠odo
                const hasPaidBBVA = realPayments[`${index}-bbva`];
                const hasPaidCMR = realPayments[`${index}-cmr`];
                const hasPaidBCP = realPayments[`${index}-bcp`];
                
                if (hasPaidBBVA || hasPaidCMR || hasPaidBCP) {
                    tr.classList.add('paid-row');
                }
                
                const cells = [
                    row.period,
                    formatMoney(row.income),
                    formatMoney(row.expenses),
                    row.bbva ? formatMoney(row.bbva) : '‚Äî',
                    hasPaidBBVA ? formatMoney(hasPaidBBVA.amount) : '‚Äî',
                    row.cmr ? formatMoney(row.cmr) : '‚Äî',
                    hasPaidCMR ? formatMoney(hasPaidCMR.amount) : '‚Äî',
                    row.bcp ? formatMoney(row.bcp) : '‚Äî',
                    hasPaidBCP ? formatMoney(hasPaidBCP.amount) : '‚Äî',
                    currentBalances.cmr <= 0 ? 'LIQUIDADA ‚úÖ' : formatMoney(Math.round(currentBalances.cmr)),
                    currentBalances.bcp <= 0 ? 'LIQUIDADA ‚úÖ' : formatMoney(Math.round(currentBalances.bcp)),
                    formatMoney(Math.round(currentBalances.bbva)),
                    (hasPaidBBVA || hasPaidCMR || hasPaidBCP) ? '‚úÖ PAGADO' : '‚è≥ Pendiente'
                ];
                
                cells.forEach((cell, cellIndex) => {
                    const td = document.createElement('td');
                    td.innerHTML = cell;
                    
                    if (cellIndex >= 3 && cellIndex <= 8 && cell !== '‚Äî') {
                        td.classList.add('amount');
                        if (cellIndex % 2 === 0) { // Columnas de plan
                            td.classList.add('neutral');
                        } else { // Columnas de real
                            td.classList.add('positive');
                        }
                    }
                    
                    if (cell.includes('LIQUIDADA')) {
                        td.classList.add('liquidated');
                    }
                    
                    tr.appendChild(td);
                });
                
                tbody.appendChild(tr);
            });
        }

        function updateStats() {
            const totalPaid = Object.values(realPayments).reduce((sum, payment) => sum + payment.amount, 0);
            const totalInitial = 5826;
            const totalCurrent = currentBalances.bbva + currentBalances.cmr + currentBalances.bcp;
            const progress = ((totalInitial - totalCurrent) / totalInitial) * 100;
            
            document.getElementById('totalPayments').textContent = formatMoney(totalPaid);
            document.getElementById('progressPercent').textContent = progress.toFixed(1) + '%';
            document.getElementById('totalDebt').textContent = formatMoney(totalCurrent);
        }

        function updateChart() {
            const ctx = document.getElementById('debtChart');
            if (window.debtChart) {
                window.debtChart.destroy();
            }
            
            const labels = ['Inicial', 'Actual', 'Proyecci√≥n Oct', 'Proyecci√≥n Nov', 'Proyecci√≥n Dic'];
            const bbvaData = [
                initialBalances.bbva,
                currentBalances.bbva,
                Math.max(0, currentBalances.bbva - 373),
                Math.max(0, currentBalances.bbva - 746),
                Math.max(0, currentBalances.bbva - 1319)
            ];
            const cmrData = [
                initialBalances.cmr,
                currentBalances.cmr,
                Math.max(0, currentBalances.cmr),
                0,
                0
            ];
            const bcpData = [
                initialBalances.bcp,
                currentBalances.bcp,
                Math.max(0, currentBalances.bcp),
                0,
                0
            ];
            
            window.debtChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'BBVA (Real)',
                            data: bbvaData,
                            borderColor: '#1e3a8a',
                            backgroundColor: 'rgba(30, 58, 138, 0.1)',
                            tension: 0.4,
                            fill: true,
                            borderWidth: 3
                        },
                        {
                            label: 'CMR Falabella (Real)',
                            data: cmrData,
                            borderColor: '#dc2626',
                            backgroundColor: 'rgba(220, 38, 38, 0.1)',
                            tension: 0.4,
                            fill: true,
                            borderWidth: 3
                        },
                        {
                            label: 'BCP Visa (Real)',
                            data: bcpData,
                            borderColor: '#059669',
                            backgroundColor: 'rgba(5, 150, 105, 0.1)',
                            tension: 0.4,
                            fill: true,
                            borderWidth: 3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Evoluci√≥n Real de Deudas vs Proyecci√≥n',
                            font: { size: 18, weight: 'bold' }
                        },
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'S/ ' + value.toLocaleString('es-PE');
                                }
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        function updateDebtCards() {
            const container = document.getElementById('debtCards');
            container.innerHTML = '';
            
            const cards = [
                { name: 'BBVA', balance: currentBalances.bbva, class: 'bbva', initial: initialBalances.bbva },
                { name: 'CMR Falabella', balance: currentBalances.cmr, class: 'cmr', initial: initialBalances.cmr },
                { name: 'BCP Visa', balance: currentBalances.bcp, class: 'bcp', initial: initialBalances.bcp }
            ];
            
            cards.forEach(card => {
                const progress = Math.max(0, ((card.initial - card.balance) / card.initial) * 100);
                const isLiquidated = card.balance <= 0;
                
                const cardHtml = `
                    <div class="debt-card">
                        <div class="debt-title ${card.class}">üí≥ ${card.name}</div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress}%"></div>
                        </div>
                        <p><strong>Saldo inicial:</strong> <span class="amount neutral">${formatMoney(card.initial)}</span></p>
                        <p><strong>Saldo actual:</strong> 
                            <span class="amount ${isLiquidated ? 'liquidated' : 'negative'}">
                                ${isLiquidated ? 'LIQUIDADA ‚úÖ' : formatMoney(card.balance)}
                            </span>
                        </p>
                        <p><strong>Reducido:</strong> <span class="amount positive">${formatMoney(card.initial - card.balance)}</span></p>
                        <p><strong>Progreso:</strong> <span class="amount">${progress.toFixed(1)}%</span></p>
                    </div>
                `;
                container.innerHTML += cardHtml;
            });
        }

        function showAlert(message, type) {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert ${type}`;
            alert.textContent = message;
            container.innerHTML = '';
            container.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        function showPaymentHistory() {
            const historySection = document.getElementById('paymentHistory');
            const historyList = document.getElementById('historyList');
            
            if (Object.keys(realPayments).length === 0) {
                historySection.style.display = 'none';
                return;
            }
            
            historySection.style.display = 'block';
            historyList.innerHTML = '';
            
            Object.values(realPayments)
                .sort((a, b) => new Date(a.date) - new Date(b.date))
                .forEach(payment => {
                    const difference = payment.amount - payment.planned;
                    const diffText = difference > 0 ? `+${formatMoney(difference)}` : 
                                   difference < 0 ? formatMoney(difference) : 'Exacto';
                    
                    const item = document.createElement('div');
                    item.className = 'history-item';
                    item.innerHTML = `
                        <div>
                            <strong>${payment.period}</strong> - ${payment.bank.toUpperCase()}<br>
                            <small>${payment.date}</small>
                        </div>
                        <div style="text-align: right;">
                            <div class="amount positive">${formatMoney(payment.amount)}</div>
                            <small class="${difference >= 0 ? 'positive' : 'negative'}">${diffText}</small>
                        </div>
                    `;
                    historyList.appendChild(item);
                });
        }

        function showPlanVsReal() {
            const totalPlanned = originalPlan.reduce((sum, period) => sum + (period.bbva || 0) + (period.cmr || 0) + (period.bcp || 0), 0);
            const totalPaid = Object.values(realPayments).reduce((sum, payment) => sum + payment.amount, 0);
            const difference = totalPaid - totalPlanned;
            
            let message = `üìä PLAN vs REALIDAD:\n\n`;
            message += `üíº Planeado total: ${formatMoney(totalPlanned)}\n`;
            message += `üí∞ Pagado real: ${formatMoney(totalPaid)}\n`;
            message += `üìà Diferencia: ${difference >= 0 ? '+' : ''}${formatMoney(difference)}\n\n`;
            
            if (difference > 0) {
                message += `üéâ ¬°VAS ADELANTADO! Excelente trabajo.`;
            } else if (difference < 0) {
                message += `‚ö†Ô∏è Vas un poco atrasado, pero puedes recuperarte.`;
            } else {
                message += `‚úÖ Siguiendo el plan exactamente.`;
            }
            
            alert(message);
        }

        async function resetAllData() {
            if (confirm('‚ö†Ô∏è ¬øEst√°s seguro de borrar todos los pagos registrados?')) {
                // Limpiar datos locales
                realPayments = {};
                currentBalances = { ...initialBalances };
                
                // Limpiar Firebase si est√° disponible
                if (window.isFirebaseReady) {
                    try {
                        const querySnapshot = await window.getDocs(window.collection(window.db, "payments"));
                        const deletePromises = [];
                        querySnapshot.forEach((document) => {
                            deletePromises.push(window.deleteDoc(window.doc(window.db, "payments", document.id)));
                        });
                        await Promise.all(deletePromises);
                        showAlert('üîÑ Datos eliminados de Firebase', 'warning');
                    } catch (error) {
                        console.error('Error eliminando de Firebase:', error);
                    }
                }
                
                updateTable();
                updateStats();
                updateChart();
                updateDebtCards();
                showPaymentHistory();
                showAlert('üîÑ Todos los datos han sido reseteados', 'warning');
            }
        }

        function showProjection() {
            const remainingDebt = currentBalances.bbva + currentBalances.cmr + currentBalances.bcp;
            const monthsToFinish = Math.ceil(remainingDebt / 1200); // Asumiendo capacidad promedio
            
            let message = `üîÆ PROYECCI√ìN ACTUALIZADA:\n\n`;
            message += `üí∞ Deuda restante: ${formatMoney(remainingDebt)}\n`;
            message += `üìÖ Meses estimados para liquidar: ${monthsToFinish}\n`;
            message += `üéØ Fecha estimada de libertad: ${new Date(Date.now() + monthsToFinish * 30 * 24 * 60 * 60 * 1000).toLocaleDateString('es-PE')}\n\n`;
            
            if (currentBalances.cmr <= 0) message += `‚úÖ CMR Falabella: LIQUIDADA\n`;
            if (currentBalances.bcp <= 0) message += `‚úÖ BCP Visa: LIQUIDADA\n`;
            if (currentBalances.bbva <= 3076) message += `‚úÖ BBVA: Solo cuotas 0% restantes\n`;
            
            alert(message);
        }

        function exportToCSV() {
            let csv = 'Per√≠odo,Plan BBVA,Real BBVA,Plan CMR,Real CMR,Plan BCP,Real BCP,Estado\n';
            
            originalPlan.forEach((row, index) => {
                const realBBVA = realPayments[`${index}-bbva`]?.amount || 0;
                const realCMR = realPayments[`${index}-cmr`]?.amount || 0;
                const realBCP = realPayments[`${index}-bcp`]?.amount || 0;
                const status = (realBBVA || realCMR || realBCP) ? 'PAGADO' : 'PENDIENTE';
                
                csv += `"${row.period}",${row.bbva || 0},${realBBVA},${row.cmr || 0},${realCMR},${row.bcp || 0},${realBCP},${status}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `plan_deudas_alejandro_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Funci√≥n para cargar datos desde Firebase al inicializar
        async function initializeApp() {
            populatePeriodDropdown();
            
            // Cargar datos desde Firebase si est√° disponible
            if (window.isFirebaseReady) {
                await window.loadFromFirebase();
            }
            
            updateTable();
            updateStats();
            updateChart();
            updateDebtCards();
            showPaymentHistory();
        }

        // Inicializar la aplicaci√≥n cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', function() {
            // Esperar un poco para que Firebase se inicialice
            setTimeout(initializeApp, 500);
        });
    </script>
</body>
</html>